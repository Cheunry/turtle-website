# é‰´æƒç³»ç»Ÿåˆ†æä¸æ”¹è¿›å»ºè®®

## ä¸€ã€å½“å‰é‰´æƒå®ç°åˆ†æ

### 1.1 åç«¯é‰´æƒæµç¨‹

#### æ ¸å¿ƒç»„ä»¶
- **JwtService**: JWTç”Ÿæˆå’Œè§£ææœåŠ¡
- **AuthInterceptor**: è®¤è¯æˆæƒæ‹¦æˆªå™¨ï¼ˆä¸¥æ ¼æ¨¡å¼ï¼‰
- **TokenParseInterceptor**: Tokenè§£ææ‹¦æˆªå™¨ï¼ˆå®½æ¾æ¨¡å¼ï¼Œä»…è§£æä¸éªŒè¯ï¼‰
- **TokenBlacklistService**: Tokené»‘åå•æœåŠ¡ï¼ˆåŸºäºRedisï¼‰

#### é‰´æƒæµç¨‹
```
1. ç”¨æˆ·ç™»å½• â†’ ç”ŸæˆJWT Tokenï¼ˆ7å¤©æœ‰æ•ˆæœŸï¼‰
2. å‰ç«¯è¯·æ±‚ â†’ åœ¨Headerä¸­æºå¸¦Authorization: <token>
3. AuthInterceptoræ‹¦æˆª â†’ éªŒè¯æµç¨‹ï¼š
   a. æ£€æŸ¥Tokenæ˜¯å¦å­˜åœ¨
   b. æ£€æŸ¥Tokenæ˜¯å¦åœ¨é»‘åå•ä¸­
   c. è§£æTokenè·å–userId
   d. ä»ç¼“å­˜è·å–ç”¨æˆ·ä¿¡æ¯
   e. éªŒè¯ç”¨æˆ·çŠ¶æ€ï¼ˆæ˜¯å¦è¢«ç¦ç”¨ï¼‰
   f. è®¾ç½®UserHolderï¼ˆThreadLocalï¼‰
4. è¯·æ±‚å¤„ç†å®Œæˆå â†’ æ¸…ç†UserHolder
```

#### å…³é”®ç‰¹æ€§
- âœ… JWTæ— çŠ¶æ€è®¤è¯
- âœ… Tokené»‘åå•æœºåˆ¶ï¼ˆæ”¯æŒç™»å‡ºï¼‰
- âœ… ç”¨æˆ·çŠ¶æ€éªŒè¯ï¼ˆç¦ç”¨æ£€æŸ¥ï¼‰
- âœ… ç¼“å­˜ä¼˜åŒ–ï¼ˆå‡å°‘æ•°æ®åº“æŸ¥è¯¢ï¼‰
- âœ… ç³»ç»Ÿæ ‡è¯†éš”ç¦»ï¼ˆfront/author/adminï¼‰

### 1.2 å‰ç«¯é‰´æƒæµç¨‹

#### æ ¸å¿ƒç»„ä»¶
- **auth.js**: Tokenå­˜å‚¨ç®¡ç†ï¼ˆlocalStorageï¼‰
- **request.js**: Axiosè¯·æ±‚æ‹¦æˆªå™¨
- **Top.vue**: ç™»å‡ºåŠŸèƒ½

#### é‰´æƒæµç¨‹
```
1. ç™»å½•æˆåŠŸ â†’ å­˜å‚¨tokenåˆ°localStorage
2. è¯·æ±‚æ‹¦æˆªå™¨ â†’ è‡ªåŠ¨æ·»åŠ Authorization header
3. å“åº”æ‹¦æˆªå™¨ â†’ å¤„ç†A0230é”™è¯¯ç ï¼ˆç™»å½•è¿‡æœŸï¼‰
4. ç™»å‡º â†’ è°ƒç”¨åç«¯æ¥å£åŠ å…¥é»‘åå• + æ¸…é™¤æœ¬åœ°å­˜å‚¨
```

#### å…³é”®ç‰¹æ€§
- âœ… è‡ªåŠ¨æ·»åŠ Tokenåˆ°è¯·æ±‚å¤´
- âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†ï¼ˆA0230è‡ªåŠ¨ç™»å‡ºï¼‰
- âœ… ç™»å‡ºæ—¶é€šçŸ¥å…¶ä»–ç»„ä»¶ï¼ˆSSEæ–­å¼€ï¼‰
- âŒ ç¼ºå°‘è·¯ç”±å®ˆå«
- âŒ ç¼ºå°‘Tokenè¿‡æœŸæ—¶é—´æ£€æŸ¥
- âŒ ç¼ºå°‘Tokenåˆ·æ–°æœºåˆ¶

## äºŒã€å­˜åœ¨çš„é—®é¢˜

### 2.1 å®‰å…¨æ€§é—®é¢˜

#### ğŸ”´ é«˜ä¼˜å…ˆçº§
1. **Tokenè¿‡æœŸæ—¶é—´è¿‡é•¿ï¼ˆ7å¤©ï¼‰**
   - é£é™©ï¼šTokenæ³„éœ²åæœ‰æ•ˆæœŸè¿‡é•¿
   - å»ºè®®ï¼šç¼©çŸ­ä¸º1-2å¤©ï¼Œé…åˆåˆ·æ–°æœºåˆ¶

2. **ç¼ºå°‘è·¯ç”±å®ˆå«**
   - é£é™©ï¼šæœªç™»å½•ç”¨æˆ·å¯ç›´æ¥è®¿é—®éœ€è¦è®¤è¯çš„é¡µé¢
   - å½±å“ï¼šç”¨æˆ·ä½“éªŒå·®ï¼Œå¯èƒ½æš´éœ²æ•æ„Ÿä¿¡æ¯

3. **Tokené»‘åå•ä½¿ç”¨å®Œæ•´Tokenä½œä¸ºKey**
   - é—®é¢˜ï¼šTokenè¾ƒé•¿ï¼Œå ç”¨Rediså†…å­˜
   - å»ºè®®ï¼šä½¿ç”¨Tokençš„hashå€¼ä½œä¸ºkey

#### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§
4. **ç¼ºå°‘Tokenåˆ·æ–°æœºåˆ¶**
   - é—®é¢˜ï¼šç”¨æˆ·éœ€è¦é¢‘ç¹é‡æ–°ç™»å½•
   - å»ºè®®ï¼šå®ç°Refresh Tokenæœºåˆ¶

5. **å‰ç«¯æ²¡æœ‰Tokenè¿‡æœŸæ—¶é—´æ£€æŸ¥**
   - é—®é¢˜ï¼šTokenè¿‡æœŸåä»ä¼šå‘é€è¯·æ±‚
   - å»ºè®®ï¼šå‰ç«¯æ£€æŸ¥Tokenè¿‡æœŸæ—¶é—´ï¼Œæå‰åˆ·æ–°

6. **é”™è¯¯ç ä¸å¤Ÿç»†åŒ–**
   - é—®é¢˜ï¼šæ‰€æœ‰è®¤è¯å¤±è´¥éƒ½è¿”å›A0230
   - å»ºè®®ï¼šåŒºåˆ†Tokenç¼ºå¤±ã€è¿‡æœŸã€é»‘åå•ç­‰åœºæ™¯

### 2.2 æ€§èƒ½é—®é¢˜

1. **æ¯æ¬¡è¯·æ±‚éƒ½æ£€æŸ¥é»‘åå•**
   - ä¼˜åŒ–ï¼šä½¿ç”¨Bloom Filterå‡å°‘RedisæŸ¥è¯¢

2. **ç”¨æˆ·ä¿¡æ¯ç¼“å­˜å¯èƒ½è¿‡æœŸ**
   - ä¼˜åŒ–ï¼šå®ç°ç¼“å­˜é¢„çƒ­å’Œæ›´æ–°ç­–ç•¥

### 2.3 ç”¨æˆ·ä½“éªŒé—®é¢˜

1. **Tokenè¿‡æœŸåç›´æ¥è·³è½¬ç™»å½•é¡µ**
   - å»ºè®®ï¼šæç¤ºç”¨æˆ·Tokenå³å°†è¿‡æœŸï¼Œè‡ªåŠ¨åˆ·æ–°

2. **æ²¡æœ‰è®°ä½ç™»å½•çŠ¶æ€é€‰é¡¹**
   - å»ºè®®ï¼šæä¾›"è®°ä½æˆ‘"åŠŸèƒ½ï¼Œå»¶é•¿Tokenæœ‰æ•ˆæœŸ

## ä¸‰ã€æ”¹è¿›å»ºè®®

### 3.1 çŸ­æœŸæ”¹è¿›ï¼ˆ1-2å‘¨ï¼‰

#### 1. æ·»åŠ å‰ç«¯è·¯ç”±å®ˆå«
```javascript
// router/index.js
router.beforeEach((to, from, next) => {
  const token = getToken()
  const requiresAuth = to.matched.some(record => record.meta.requiresAuth)
  
  if (requiresAuth && !token) {
    next({ name: 'login', query: { redirect: to.fullPath } })
  } else {
    next()
  }
})
```

#### 2. ä¼˜åŒ–Tokené»‘åå•Key
```java
// TokenBlacklistService.java
public void addToBlacklist(String token) {
    // ä½¿ç”¨Tokençš„hashå€¼ä½œä¸ºkeyï¼Œå‡å°‘å†…å­˜å ç”¨
    String tokenHash = DigestUtils.md5Hex(token);
    String key = CacheConsts.TOKEN_BLACKLIST_PREFIX + tokenHash;
    stringRedisTemplate.opsForValue().set(key, token, 7, TimeUnit.DAYS);
}
```

#### 3. å‰ç«¯Tokenè¿‡æœŸæ£€æŸ¥
```javascript
// utils/auth.js
export const isTokenExpired = () => {
  const token = getToken()
  if (!token) return true
  
  try {
    const payload = JSON.parse(atob(token.split('.')[1]))
    const exp = payload.exp * 1000 // è½¬æ¢ä¸ºæ¯«ç§’
    return Date.now() >= exp
  } catch {
    return true
  }
}
```

#### 4. ç»†åŒ–é”™è¯¯ç 
```java
// ErrorCodeEnum.java
AUTH_TOKEN_MISSING("A0231", "Tokenç¼ºå¤±"),
AUTH_TOKEN_EXPIRED("A0232", "Tokenå·²è¿‡æœŸ"),
AUTH_TOKEN_INVALID("A0233", "Tokenæ— æ•ˆ"),
AUTH_TOKEN_BLACKLISTED("A0234", "Tokenå·²è¢«æ³¨é”€"),
```

### 3.2 ä¸­æœŸæ”¹è¿›ï¼ˆ1-2æœˆï¼‰

#### 1. å®ç°Refresh Tokenæœºåˆ¶
```
æ¶æ„è®¾è®¡ï¼š
- Access Token: çŸ­æœŸæœ‰æ•ˆï¼ˆ15åˆ†é’Ÿ-1å°æ—¶ï¼‰ï¼Œç”¨äºAPIè¯·æ±‚
- Refresh Token: é•¿æœŸæœ‰æ•ˆï¼ˆ7-30å¤©ï¼‰ï¼Œç”¨äºåˆ·æ–°Access Token
- Refresh Tokenå­˜å‚¨åœ¨HttpOnly Cookieä¸­ï¼Œæé«˜å®‰å…¨æ€§
```

#### 2. å®ç°Tokenè‡ªåŠ¨åˆ·æ–°
```javascript
// utils/request.js
// åœ¨å“åº”æ‹¦æˆªå™¨ä¸­æ£€æµ‹Tokenå³å°†è¿‡æœŸï¼Œè‡ªåŠ¨åˆ·æ–°
if (res.data.code === 'A0232') { // Tokenå³å°†è¿‡æœŸ
  try {
    const newToken = await refreshToken()
    setToken(newToken)
    // é‡è¯•åŸè¯·æ±‚
    return axios.request(error.config)
  } catch {
    // åˆ·æ–°å¤±è´¥ï¼Œè·³è½¬ç™»å½•
  }
}
```

#### 3. ä½¿ç”¨Bloom Filterä¼˜åŒ–é»‘åå•æŸ¥è¯¢
```java
// ä½¿ç”¨Guava BloomFilterå‡å°‘RedisæŸ¥è¯¢
private final BloomFilter<String> tokenBlacklistFilter;

public boolean isBlacklisted(String token) {
    if (!tokenBlacklistFilter.mightContain(token)) {
        return false; // è‚¯å®šä¸åœ¨é»‘åå•ä¸­
    }
    // å¯èƒ½åœ¨é»‘åå•ä¸­ï¼ŒæŸ¥è¯¢Redisç¡®è®¤
    return stringRedisTemplate.hasKey(key);
}
```

### 3.3 é•¿æœŸæ”¹è¿›ï¼ˆ3-6æœˆï¼‰

#### 1. å®ç°å¤šè®¾å¤‡ç™»å½•ç®¡ç†
- è®°å½•ç”¨æˆ·ç™»å½•è®¾å¤‡ä¿¡æ¯
- æ”¯æŒæŸ¥çœ‹å’Œè¸¢å‡ºå…¶ä»–è®¾å¤‡
- æ”¯æŒå•è®¾å¤‡ç™»å½•æ¨¡å¼

#### 2. å®ç°é£é™©æ£€æµ‹
- å¼‚å¸¸ç™»å½•åœ°ç‚¹æ£€æµ‹
- å¼‚å¸¸ç™»å½•æ—¶é—´æ£€æµ‹
- é¢‘ç¹ç™»å½•å¤±è´¥æ£€æµ‹

#### 3. å®ç°OAuth2.0é›†æˆ
- æ”¯æŒç¬¬ä¸‰æ–¹ç™»å½•ï¼ˆå¾®ä¿¡ã€QQç­‰ï¼‰
- ç»Ÿä¸€è®¤è¯ä¸­å¿ƒ

## å››ã€å®æ–½ä¼˜å…ˆçº§

### P0ï¼ˆç«‹å³å®æ–½ï¼‰
1. âœ… æ·»åŠ å‰ç«¯è·¯ç”±å®ˆå«
2. âœ… ä¼˜åŒ–Tokené»‘åå•Keyï¼ˆä½¿ç”¨hashï¼‰
3. âœ… å‰ç«¯Tokenè¿‡æœŸæ£€æŸ¥

### P1ï¼ˆ1ä¸ªæœˆå†…ï¼‰
1. å®ç°Refresh Tokenæœºåˆ¶
2. ç»†åŒ–é”™è¯¯ç 
3. å®ç°Tokenè‡ªåŠ¨åˆ·æ–°

### P2ï¼ˆ3ä¸ªæœˆå†…ï¼‰
1. ä½¿ç”¨Bloom Filterä¼˜åŒ–
2. å®ç°å¤šè®¾å¤‡ç™»å½•ç®¡ç†
3. å®ç°é£é™©æ£€æµ‹

## äº”ã€ä»£ç ç¤ºä¾‹

### 5.1 å‰ç«¯è·¯ç”±å®ˆå«å®ç°
```javascript
// router/index.js
import { getToken } from '@/utils/auth'

const routes = [
  // ... ç°æœ‰è·¯ç”±
  {
    path: '/user/setup',
    name: 'userSetup',
    component: () => import('@/views/UserSetup'),
    meta: { requiresAuth: true }
  },
  // ... å…¶ä»–éœ€è¦è®¤è¯çš„è·¯ç”±
]

router.beforeEach((to, from, next) => {
  const token = getToken()
  const requiresAuth = to.matched.some(record => record.meta.requiresAuth)
  
  if (requiresAuth && !token) {
    ElMessage.warning('è¯·å…ˆç™»å½•')
    next({ 
      name: 'login', 
      query: { redirect: to.fullPath } 
    })
  } else {
    next()
  }
})
```

### 5.2 Tokené»‘åå•ä¼˜åŒ–
```java
// TokenBlacklistService.java
import org.springframework.util.DigestUtils;

public void addToBlacklist(String token) {
    // ä½¿ç”¨MD5 hashå‡å°‘keyé•¿åº¦
    String tokenHash = DigestUtils.md5Hex(token);
    String key = CacheConsts.TOKEN_BLACKLIST_PREFIX + tokenHash;
    // å­˜å‚¨å®Œæ•´tokenç”¨äºéªŒè¯ï¼Œä½†keyä½¿ç”¨hash
    stringRedisTemplate.opsForValue().set(key, token, 7, TimeUnit.DAYS);
    log.debug("Tokenå·²åŠ å…¥é»‘åå•: {}", tokenHash);
}

public boolean isBlacklisted(String token) {
    String tokenHash = DigestUtils.md5Hex(token);
    String key = CacheConsts.TOKEN_BLACKLIST_PREFIX + tokenHash;
    Boolean exists = stringRedisTemplate.hasKey(key);
    return Boolean.TRUE.equals(exists);
}
```

### 5.3 å‰ç«¯Tokenè¿‡æœŸæ£€æŸ¥
```javascript
// utils/auth.js
export const isTokenExpired = () => {
  const token = getToken()
  if (!token) return true
  
  try {
    // JWTæ ¼å¼: header.payload.signature
    const payload = JSON.parse(atob(token.split('.')[1]))
    const exp = payload.exp * 1000 // JWT expæ˜¯ç§’ï¼Œè½¬æ¢ä¸ºæ¯«ç§’
    const now = Date.now()
    // æå‰5åˆ†é’Ÿè®¤ä¸ºè¿‡æœŸï¼Œç»™åˆ·æ–°ç•™å‡ºæ—¶é—´
    return now >= (exp - 5 * 60 * 1000)
  } catch (e) {
    console.error('Tokenè§£æå¤±è´¥:', e)
    return true
  }
}

export const getTokenExpirationTime = () => {
  const token = getToken()
  if (!token) return null
  
  try {
    const payload = JSON.parse(atob(token.split('.')[1]))
    return payload.exp * 1000
  } catch {
    return null
  }
}
```

## å…­ã€æ€»ç»“

å½“å‰é‰´æƒç³»ç»Ÿå·²ç»å®ç°äº†åŸºæœ¬çš„JWTè®¤è¯å’ŒTokené»‘åå•æœºåˆ¶ï¼Œä½†åœ¨ä»¥ä¸‹æ–¹é¢è¿˜æœ‰æ”¹è¿›ç©ºé—´ï¼š

1. **å®‰å…¨æ€§**ï¼šéœ€è¦æ·»åŠ è·¯ç”±å®ˆå«ã€ç¼©çŸ­Tokenæœ‰æ•ˆæœŸã€å®ç°åˆ·æ–°æœºåˆ¶
2. **æ€§èƒ½**ï¼šä¼˜åŒ–é»‘åå•å­˜å‚¨ã€ä½¿ç”¨Bloom Filter
3. **ç”¨æˆ·ä½“éªŒ**ï¼šè‡ªåŠ¨åˆ·æ–°Tokenã€ç»†åŒ–é”™è¯¯æç¤º

å»ºè®®æŒ‰ç…§ä¼˜å…ˆçº§é€æ­¥å®æ–½æ”¹è¿›ï¼Œä¼˜å…ˆå®ŒæˆP0çº§åˆ«çš„æ”¹è¿›ï¼Œè¿™äº›æ”¹è¿›å¯¹ç³»ç»Ÿå®‰å…¨æ€§å’Œç”¨æˆ·ä½“éªŒæœ‰ç›´æ¥å½±å“ã€‚
