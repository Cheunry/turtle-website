# 限流、熔断、降级 - 面试回答

## 问题：限流、熔断、降级如何实现？阈值如何设置？

---

## 回答

我们项目主要通过 **Sentinel + Feign Fallback + 业务降级** 来实现限流、熔断和降级。

### 限流实现

**第一个是 Sentinel 限流**。我们引入了 `spring-cloud-starter-alibaba-sentinel`，可以在 Gateway 层面和服务层面做限流。Gateway 层面可以配置基于 IP、路径、服务名的限流规则，服务层面可以通过 `@SentinelResource` 注解配置方法级别的限流。

**第二个是业务层限流**。比如积分扣减，我们通过 Redis SETNX 做分布式锁，防止并发重复扣减。访问量统计通过 Redis Pipeline 批量处理，减少数据库压力。

**阈值设置**：
- **Gateway 层面**：一般设置 QPS 限流，比如单个 IP 每秒 100 次请求，单个服务每秒 1000 次请求
- **服务层面**：根据接口特点设置，比如查询接口 QPS 1000，写接口 QPS 100
- **业务层**：通过 Redis 锁和批量处理，控制并发度

### 熔断实现

**主要通过 Feign Fallback 实现**。所有 Feign 接口都配置了 fallback，当服务调用失败或超时时，会触发降级逻辑。

**具体实现**：
- **BookFeign**：使用 `FallbackFactory`，可以获取异常信息，返回空列表或错误响应
- **AiFeign**：使用 `Fallback`，AI 服务不可用时返回失败响应
- **UserFeign**：使用 `Fallback`，用户服务不可用时返回空列表或错误响应

**熔断策略**：
- **超时时间**：读操作 3 秒，写操作 5 秒，AI 生图 180 秒
- **重试机制**：Spring Cloud LoadBalancer 启用重试，失败自动重试一次
- **熔断条件**：服务调用失败或超时，触发 fallback

### 降级实现

**第一个是 Feign Fallback 降级**。当服务不可用时，返回默认值或错误响应，保证主流程不中断。

**具体场景**：
- **书籍服务降级**：`listBookInfoByIdsForBookshelf` 返回提示信息"系统维护中..."，而不是直接报错
- **AI 服务降级**：审核、生图等服务不可用时，返回失败响应，业务层可以记录日志后续补偿
- **用户服务降级**：批量查询用户信息失败时，返回空列表，不影响主流程

**第二个是业务层降级**。当依赖的外部服务或中间件异常时，降级到备用方案。

**具体场景**：
- **Redis 异常降级**：访问量统计时，如果 Redis 异常，降级为直接写数据库 + 发 MQ，保证数据不丢失
- **向量生成失败降级**：搜索服务中，如果向量生成失败，降级为纯文本搜索（BM25），保证搜索功能可用
- **缓存解析失败降级**：书籍详情查询时，如果缓存解析失败，降级为直接查数据库

### 阈值设置原则

**第一个是根据业务特点**。查询接口可以设置较高的 QPS，写接口设置较低的 QPS。比如书籍查询接口 QPS 1000，书籍提交接口 QPS 100。

**第二个是根据系统容量**。根据服务的实际处理能力设置阈值，一般设置为服务最大处理能力的 70%-80%，留出余量应对突发流量。

**第三个是动态调整**。通过 Nacos 配置中心动态调整限流规则，不需要重启服务。可以根据监控数据实时调整，比如高峰期提高限流阈值，低峰期降低限流阈值。

**第四个是分级限流**。Gateway 层面做全局限流，服务层面做接口限流，业务层面做细粒度限流。这样既能保护系统，又能保证核心功能可用。

### 实际应用案例

**第一个是 AI 服务降级**。AI 审核、生图等服务可能因为外部 API 限制或网络问题不可用，我们通过 Feign Fallback 返回失败响应，业务层记录日志，后续可以通过定时任务补偿。

**第二个是搜索服务降级**。向量生成可能因为 API 调用失败，我们降级为纯文本搜索，虽然搜索效果可能差一点，但保证了搜索功能可用。

**第三个是访问量统计降级**。高并发场景下，如果 Redis 异常，我们降级为直接写数据库 + 发 MQ，保证数据不丢失，虽然性能可能差一点，但保证了数据一致性。

### 总结

整体来说，我们通过 **Sentinel 限流、Feign Fallback 熔断、业务层降级** 的组合方案，既保护了系统不被突发流量打垮，又保证了核心功能的可用性。阈值设置根据业务特点和系统容量动态调整，通过 Nacos 配置中心可以实时更新，不需要重启服务。

---

## 可能的追问点

### 1. Sentinel 限流规则如何配置？
可以通过 Sentinel 控制台配置，也可以通过代码配置。我们项目里，限流规则可以放在 Nacos 配置中心，动态更新。一般配置 QPS 限流，比如单个 IP 每秒 100 次请求，单个服务每秒 1000 次请求。还可以配置并发线程数限流，防止线程池耗尽。

### 2. Feign Fallback 和 FallbackFactory 的区别？
`Fallback` 是简单的降级处理，不能获取异常信息。`FallbackFactory` 可以获取异常信息，可以根据不同的异常类型做不同的降级处理。我们项目里，`BookFeign` 用 `FallbackFactory`，可以记录异常日志，`AiFeign` 和 `UserFeign` 用 `Fallback`，简单返回错误响应。

### 3. 如何判断服务是否需要熔断？
我们通过 Feign 的超时时间和重试机制判断。如果服务调用超时或失败，会触发 fallback。还可以通过 Sentinel 配置熔断规则，比如错误率超过 50% 或响应时间超过 1 秒，自动熔断。熔断后，会在一段时间内直接返回 fallback，不再调用真实服务。

### 4. 降级策略如何选择？
我们根据业务特点选择降级策略：
- **返回默认值**：比如书籍列表查询失败，返回空列表
- **返回提示信息**：比如书架服务不可用，返回"系统维护中..."
- **降级到备用方案**：比如向量搜索失败，降级为文本搜索
- **记录日志后续补偿**：比如 AI 审核失败，记录日志，后续补偿

### 5. 如何监控限流、熔断、降级？
我们通过日志和监控系统监控。Feign Fallback 会记录异常日志，Sentinel 控制台可以查看限流和熔断的实时数据。还可以通过 SkyWalking 监控服务调用链，发现性能瓶颈。关键指标包括：QPS、错误率、响应时间、限流次数、熔断次数等。

### 6. 限流、熔断、降级的优先级？
我们采用分层防护：
- **第一层**：Gateway 层面限流，防止突发流量进入系统
- **第二层**：服务层面限流和熔断，保护单个服务不被拖垮
- **第三层**：业务层降级，保证核心功能可用

这样既能保护系统，又能保证用户体验。

### 7. 如何测试限流、熔断、降级？
我们通过压测工具测试限流效果，比如 JMeter 或 Gatling。可以模拟高并发请求，观察限流是否生效。熔断可以通过模拟服务异常测试，比如关闭某个服务，观察 fallback 是否触发。降级可以通过模拟依赖服务异常测试，比如关闭 Redis，观察降级逻辑是否生效。
