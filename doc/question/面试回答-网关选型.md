# 网关选型 - 面试回答

## 问题：novel-gateway 基于 Spring Cloud Gateway 还是 Zuul？为什么？

---

## 回答

我们项目用的是 **Spring Cloud Gateway**，没有用 Zuul。主要考虑几个方面。

### 为什么选 Spring Cloud Gateway

**第一个是性能和架构**。Spring Cloud Gateway 基于 **WebFlux 响应式编程模型**，底层用的是 Netty，性能比 Zuul 1.x 的阻塞式模型好很多。我们项目里，网关要处理所有外部请求，包括书籍查询、搜索、AI 生图这些场景，AI 生图可能需要 20 秒左右，如果用阻塞式模型，线程会被长时间占用，影响吞吐量。Gateway 的响应式模型可以更好地处理这种长耗时请求。

**第二个是生态和维护**。我们用的是 Spring Cloud 2024.0.0，Zuul 1.x 已经进入维护模式，Netflix 不再积极开发。Spring Cloud Gateway 是 Spring 官方维护的，和 Spring Cloud 生态集成更好，文档和社区支持也更完善。而且 Gateway 支持 Spring Boot 3.x，Zuul 1.x 对 Spring Boot 3 支持不好。

**第三个是功能特性**。Gateway 的路由配置很灵活，支持基于路径、请求头、查询参数等多种断言（Predicate），还支持过滤器链，可以自定义全局过滤器和路由过滤器。我们项目里，实现了 `LoggingFilter` 全局过滤器，记录所有请求和响应的日志，方便调试和监控。还配置了 CORS 跨域处理，通过 `CorsWebFilter` 统一处理跨域请求。

**第四个是实际使用体验**。Gateway 的配置很直观，我们通过 YAML 配置路由规则，比如 `/api/front/book/**` 路由到 `novel-book-service`，`/api/front/ai/**` 路由到 `novel-ai-service`。而且 Gateway 支持动态路由，可以通过 Nacos 配置中心动态更新路由规则，不需要重启服务。我们还配置了负载均衡器（Spring Cloud LoadBalancer），支持服务发现和负载均衡。

### 关于 Zuul

**Zuul 1.x** 我们了解过，但它用的是阻塞式 Servlet 模型，每个请求会占用一个线程，高并发场景下线程资源消耗大。而且 Zuul 1.x 已经进入维护模式，Netflix 不再积极开发，不太适合新项目。

**Zuul 2.x** 虽然改成了非阻塞模型，但 Netflix 开源进度慢，而且和 Spring Cloud 集成不够好。相比之下，Spring Cloud Gateway 是 Spring 官方维护的，和 Spring Cloud 生态完美集成。

### 项目中的实际应用

我们项目里，Gateway 主要做了几件事：

**第一个是路由转发**。配置了 6 个路由规则，把不同路径的请求转发到对应的微服务，比如书籍相关请求转发到 `novel-book-service`，搜索请求转发到 `novel-search-service`，AI 相关请求转发到 `novel-ai-service`。

**第二个是请求日志**。实现了 `LoggingFilter` 全局过滤器，记录所有请求的路径、方法、头部、查询参数，以及响应的状态码，方便排查问题。

**第三个是跨域处理**。通过 `CorsWebFilter` 统一处理跨域请求，允许前端 `http://localhost:1024` 访问，支持携带 Cookie。

**第四个是超时配置**。因为 AI 生图需要较长时间，我们配置了响应超时为 180 秒，连接超时为 5 秒，保证长耗时请求不会超时。

**第五个是负载均衡**。通过 `lb://` 协议和服务发现，Gateway 会自动从 Nacos 获取服务列表，并做负载均衡。

### 总结

整体来说，选择 Spring Cloud Gateway 主要是因为它**性能好、生态完善、功能强大、维护活跃**。实际使用下来，Gateway 的响应式模型能很好地处理高并发和长耗时请求，路由配置也很灵活，自定义过滤器也很方便。而且 Gateway 和 Spring Cloud 生态集成好，和 Nacos 服务发现配合使用很顺畅。

---

## 可能的追问点

### 1. Spring Cloud Gateway 和 Zuul 的性能对比？
Gateway 基于 WebFlux 响应式模型，底层用 Netty，性能比 Zuul 1.x 的阻塞式模型好很多。我们项目里，Gateway 能很好地处理高并发请求，特别是 AI 生图这种长耗时请求，响应式模型不会阻塞线程，吞吐量更高。

### 2. Gateway 的过滤器如何实现？
我们实现了 `LoggingFilter` 全局过滤器，实现 `GlobalFilter` 和 `Ordered` 接口。在 `filter` 方法里记录请求信息，然后调用 `chain.filter(exchange)` 继续处理，最后在 `then` 回调里记录响应信息。通过 `getOrder` 方法返回 `HIGHEST_PRECEDENCE`，确保最先执行。

### 3. Gateway 如何实现动态路由？
Gateway 支持通过配置中心动态更新路由规则。我们项目里，路由配置可以放在 Nacos 配置中心，修改后 Gateway 会自动刷新，不需要重启服务。而且 Gateway 支持编程式路由，可以通过代码动态添加路由规则。

### 4. Gateway 如何处理服务发现？
Gateway 通过 `lb://` 协议和服务发现集成。我们配置了 `lb://novel-book-service`，Gateway 会从 Nacos 获取服务列表，并通过 Spring Cloud LoadBalancer 做负载均衡。如果服务实例有多个，Gateway 会自动做负载均衡。

### 5. Gateway 的限流如何实现？
Gateway 支持多种限流方式，比如基于 Redis 的令牌桶算法、基于 IP 的限流等。我们项目里，可以通过 Gateway 的过滤器实现限流，或者集成 Sentinel 做限流。不过目前我们主要用 Sentinel 在服务层面做限流，Gateway 层面还没做限流。

### 6. Gateway 如何处理长耗时请求？
我们配置了响应超时为 180 秒，因为 AI 生图需要较长时间。Gateway 的响应式模型能很好地处理长耗时请求，不会阻塞线程。如果请求超时，Gateway 会返回 504 错误，我们可以在前端做重试或提示用户。

### 7. Gateway 和 Zuul 2.x 的区别？
Zuul 2.x 虽然也改成了非阻塞模型，但 Netflix 开源进度慢，而且和 Spring Cloud 集成不够好。Gateway 是 Spring 官方维护的，和 Spring Cloud 生态完美集成，文档和社区支持也更完善。而且 Gateway 支持 Spring Boot 3.x，Zuul 2.x 对 Spring Boot 3 支持不好。
